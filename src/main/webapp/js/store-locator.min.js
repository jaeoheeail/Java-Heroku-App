L.mapbox.accessToken = 'pk.eyJ1IjoiaGFoYWhhbGlmIiwiYSI6ImNpcDlncTcwbzAxbWt0Y2x5bm96OGU0bnIifQ.qBAqQ8QaYV8M3RhHhaU_EA';
var map = L.mapbox.map('map', 'mapbox.k8xv42t9').setView([1.290270, 103.851959], 14);
var listings = document.getElementById('listings');
var selectListings = document.getElementById('selectListings');
var locations = L.mapbox.featureLayer().addTo(map);
locations.loadURL('js/eys.geojson');

function setActive(el) {
    var siblings = listings.getElementsByTagName('div');
    for (var i = 0; i < siblings.length; i++) {
        siblings[i].className = siblings[i].className.replace(/active/, '').replace(/\s\s*$/, '');
    }
    el.className += ' active';
}

function eventFire(el, etype) {
    if (el.fireEvent) {
        el.fireEvent('on' + etype);
    } else {
        var evObj = document.createEvent('Events');
        evObj.initEvent(etype, true, false);
        el.dispatchEvent(evObj);
    }
}
locations.on('ready', function() {
    locations.eachLayer(function(locale) {
        // Shorten locale.feature.properties to just `prop` so we're not
        // writing this long form over and over again.
        var prop = locale.feature.properties;
        // Each marker on the map.
        var popup = '<h3>' + prop.clinic + '</h3><div>';
        var listing = listings.appendChild(document.createElement('div'));
        listing.className = 'item';
        var selectList = selectListings.appendChild(document.createElement("option"));
        selectList.value = prop.postalCode;
        selectList.innerHTML = prop.clinic;
        var link = listing.appendChild(document.createElement('a'));
        link.href = '#';
        link.className = 'title';
        link.id = prop.postalCode;
        link.innerHTML = prop.clinic;
        if (prop.address) {
            link.innerHTML += '<br><small class="quiet">' + prop.address + ' S(' + prop.postalCode + ')</small>';
            popup += '<small class="quiet">' + prop.address + ' S(' + prop.postalCode + ')</small>';
        }
        var details = listing.appendChild(document.createElement('div'));
        details.innerHTML = prop.phoneFormatted;
        link.onclick = function() {
            setActive(listing);
            // When a menu item is clicked, animate the map to center
            // its associated locale and open its popup.
            map.setView(locale.getLatLng(), 16);
            locale.openPopup();
            return false;
        };

        // Marker interaction
        locale.on('click', function(e) {
            // 1. center the map on the selected marker.
            map.panTo(locale.getLatLng());
            // 2. Set active the markers associated listing.
            setActive(listing);
        });
        popup += '</div>';
        locale.bindPopup(popup);
    });
});
locations.on('layeradd', function(e) {
    var marker = e.layer;
    marker.setIcon(L.icon({
        iconUrl: 'img/map-marker.png',
        iconSize: [56, 56],
        iconAnchor: [28, 28],
        popupAnchor: [0, -34]
    }));
});
selectListings.onchange = function() {
    eventFire(document.getElementById(selectListings.options[selectListings.selectedIndex].value), 'click');
    return false;
};